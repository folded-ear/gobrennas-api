<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">
    <!--
    This changelog was generated by liquibase and then tweaked to act as a
    baseline (by doing MARK_RAN preconditions of non-existence).

    1.  Create src/main/resources/liquibase.properties like:

        url=jdbc:postgresql://127.0.0.1:5432/postgres
        username=postgres
        password=
        driver=org.postgresql.Driver
        outputChangeLogFile=src/main/resources/db/changelog/baseline.xml
        changeSetAuthor=liquibase (barneyb)

    2.  Empty everything after this comment out of this file.

    3.  Run `mvn liquibase:generateChangeLog` from the root directory.

    4.  Collate everything by object (e.g., table).

    5.  Add <preConditions> elements as appropriate.

    To sanity check

    1.  Run your new baseline against a blank database.

    2.  Update src/main/resources/liquibase.properties like:

        url=jdbc:postgresql://127.0.0.1:5432/new_database_up_to_baseline
        username=postgres
        password=
        driver=org.postgresql.Driver

        referenceUrl=jdbc:postgresql://127.0.0.1:5432/postgres
        referenceUsername=postgres
        referencePassword=
        referenceDriver=org.postgresql.Driver

        changeLogFile=src/main/resources/db/changelog/db.changelog-master.yaml

    3.  Run `mvn liquibase:diff` from teh root directory. You should get a bunch
        of EQUAL and NONE lines. Anything else needs to be investigated.

    4.  Once they match, run your new baseline on the _existing_ database, which
        should be a no-op. Use the diffing above to ensure it was.

    -->
    <changeSet author="liquibase (barneyb)" id="1605459081592-1">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ingredient" />
            </not>
        </preConditions>
        <createSequence sequenceName="ingredient_id_seq"/>
        <createTable tableName="ingredient">
            <column name="dtype" type="VARCHAR(31)">
                <constraints nullable="false"/>
            </column>
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="ingredient_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="aisle" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="directions" type="TEXT"/>
            <column name="external_url" type="VARCHAR(255)"/>
            <column name="display_title" type="VARCHAR(255)"/>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="owner_id" type="BIGINT"/>
            <column name="yield" type="INTEGER"/>
            <column name="calories" type="INTEGER"/>
            <column name="total_time" type="INTEGER"/>
            <column name="store_order" type="INTEGER"/>
            <column name="photo" type="VARCHAR"/>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-5">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ingredient_labels" />
            </not>
        </preConditions>
        <createTable tableName="ingredient_labels">
            <column name="ingredient_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="label_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-6">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="label" />
            </not>
        </preConditions>
        <createTable tableName="label">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_label"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-7">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="recipe_ingredients" />
            </not>
        </preConditions>
        <createTable tableName="recipe_ingredients">
            <column name="recipe_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="ingredient_id" type="BIGINT"/>
            <column name="preparation" type="VARCHAR"/>
            <column name="raw" type="VARCHAR"/>
            <column defaultValueComputed="power((2)::double precision, (30)::double precision)" name="_order" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="FLOAT8"/>
            <column name="units_id" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-8">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="task" />
            </not>
        </preConditions>
        <createSequence sequenceName="task_id_seq"/>
        <createTable tableName="task">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="task_pkey"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="position" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="BIGINT"/>
            <column name="owner_id" type="BIGINT"/>
            <column name="_type" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="date_part('epoch'::text, now())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="FLOAT8"/>
            <column name="units_id" type="BIGINT"/>
            <column name="ingredient_id" type="BIGINT"/>
            <column name="preparation" type="VARCHAR"/>
            <column defaultValueNumeric="0" name="status_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_task__eqkey" tableName="task"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-9">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="task_list_grants" />
            </not>
        </preConditions>
        <createTable tableName="task_list_grants">
            <column name="task_list_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_task_list_grants"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_task_list_grants"/>
            </column>
            <column name="level_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-10">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="unit_of_measure" />
            </not>
        </preConditions>
        <createTable tableName="unit_of_measure">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="pk_uom"/>
            </column>
            <column name="name" type="VARCHAR"/>
            <column name="plural_name" type="VARCHAR"/>
            <column defaultValueComputed="date_part('epoch'::text, now())" name="_eqkey" type="BIGINT"/>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="name" constraintName="uk_uom_name" tableName="unit_of_measure"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-11">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="unit_of_measure_aliases" />
            </not>
        </preConditions>
        <createTable tableName="unit_of_measure_aliases">
            <column name="unit_of_measure_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_uom_aliases"/>
            </column>
            <column name="alias" type="VARCHAR">
                <constraints primaryKey="true" primaryKeyName="pk_uom_aliases"/>
            </column>
        </createTable>
        <createIndex indexName="idx_uom_alias" tableName="unit_of_measure_aliases">
            <column name="alias"/>
        </createIndex>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-12">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="unit_of_measure_conversions" />
            </not>
        </preConditions>
        <createTable tableName="unit_of_measure_conversions">
            <column name="unit_of_measure_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_uom_conversions"/>
            </column>
            <column name="target_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_uom_conversions"/>
            </column>
            <column name="factor" type="FLOAT8"/>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-13">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users" />
            </not>
        </preConditions>
        <createSequence sequenceName="users_id_seq"/>
        <createTable tableName="users">
            <column autoIncrement="true" name="id" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="users_pkey"/>
            </column>
            <column name="email" type="VARCHAR(255)"/>
            <column name="image_url" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="provider" type="VARCHAR(255)"/>
            <column name="provider_id" type="VARCHAR(255)"/>
            <column defaultValueComputed="date_part('epoch'::text, now())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="email" constraintName="uk6dotkott2kjsp8vw4d0m25fb7" tableName="users"/>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_users__eqkey" tableName="users"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1605459081592-14">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_ingredient_owner" />
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="ingredient" constraintName="fk_ingredient_owner" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="ingredient_labels" constraintName="fk_ingredient_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="label_id" baseTableName="ingredient_labels" constraintName="fk_label_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="label" validate="true"/>
        <addUniqueConstraint columnNames="name" constraintName="uk_label_name" tableName="label"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="recipe_ingredients" constraintName="fk115hxprua4ai0chlhicwmuhna" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="recipe_id" baseTableName="recipe_ingredients" constraintName="fk8kr5xdvi2l7pswlri2i70g8av" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="units_id" baseTableName="recipe_ingredients" constraintName="fk_recipe_ingredients_units_id" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="task" constraintName="fk_task_ingredients_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="units_id" baseTableName="task" constraintName="fk_task_ingredients_units_id" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="task" constraintName="fk_task_owner" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="task" constraintName="fk_task_parent" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="task" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="task_list_id" baseTableName="task_list_grants" constraintName="fk_task_list_grants_task" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="task" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="task_list_grants" constraintName="fk_task_list_grants_user" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="unit_of_measure_id" baseTableName="unit_of_measure_aliases" constraintName="fk_uom_aliases_oum_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="target_id" baseTableName="unit_of_measure_conversions" constraintName="fk_oum_conversions_oum_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="unit_of_measure_id" baseTableName="unit_of_measure_conversions" constraintName="fk_oum_conversions_target_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
    </changeSet>
</databaseChangeLog>
