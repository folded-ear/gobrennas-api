<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!--
    This changelog was generated by liquibase and then tweaked to act as a
    baseline (by doing MARK_RAN preconditions of non-existence).

    1.  Create src/main/resources/liquibase.properties like:

        url=jdbc:postgresql://localhost:5432/postgres
        username=postgres
        password=passwd
        driver=org.postgresql.Driver
        outputChangeLogFile=src/main/resources/db/changelog/baseline.xml
        changeSetAuthor=liquibase (barneyb)

    2.  Run `mvn liquibase:generateChangeLog` from the root directory.

    3.  Use git to resurrect these instructions.

    4.  Collate everything by object (e.g., sequence, table).

    5.  Add <preConditions> elements as appropriate.

    6.  Manually recreate any CHECK CONSTRAINTs, as Liquibase doesn't do those.

        select *
        from pg_constraint
        where contype = 'c'

    7.  Manually convert auto-increment to use 'id_seq'.

    To sanity check

    1.  Change src/main/resources/liquibase.properties to this:

        url=jdbc:postgresql://localhost:5432/new_database_for_baseline
        username=postgres
        password=passwd
        driver=org.postgresql.Driver
        referenceUrl=jdbc:postgresql://localhost:5432/postgres
        referenceUsername=postgres
        referencePassword=passwd
        referenceDriver=org.postgresql.Driver
        changeLogFile=src/main/resources/db/changelog/db.changelog-master.yaml

    2.  Create the blank `new_database_for_baseline` database and run liquibase.
        If there are errors, fix them, drop/create the database, and try again.

        dropdb -h localhost -U postgres new_database_for_baseline \
          && createdb -h localhost -U postgres new_database_for_baseline \
          && mvn process-resources \
          && mvn liquibase:update

    3.  Run `mvn liquibase:diff` from the root directory. You should get a bunch
        of EQUAL and NONE lines. Anything else needs to be investigated.

    4.  Use pg_dump to create schema-only files of each database, and ensure
        they match.

        pg_dump -h localhost -U postgres -O -s postgres > schema-existing.sql \
          && pg_dump -h localhost -U postgres -O -s new_database_for_baseline > schema-new-baseline.sql \
          && rm schema.diff \
          && diff schema-existing.sql schema-new-baseline.sql > schema.diff || true \
          && wc -l schema.diff \
          && head -n 30 schema.diff

    5.  Once they match, run your new baseline on the _existing_ database, which
        should be a no-op. Use the diffing above to ensure it was.
    -->

    <changeSet author="liquibase (barneyb)" id="1709518116553-2">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="id_seq"/>
            </not>
        </preConditions>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="50" maxValue="9223372036854775807" minValue="1" sequenceName="id_seq" startValue="1"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-1">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="app_setting"/>
            </not>
        </preConditions>
        <createTable tableName="app_setting">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_app_setting"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="date_part('epoch'::text, clock_timestamp())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="value_str" type="VARCHAR"/>
        </createTable>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_app_setting__eqkey" tableName="app_setting"/>
        <addUniqueConstraint columnNames="name" constraintName="uk_app_setting_name" tableName="app_setting"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-3">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="compound_quantity"/>
            </not>
        </preConditions>
        <createTable tableName="compound_quantity">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_compound_quantity"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-4">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="favorite"/>
            </not>
        </preConditions>
        <createTable tableName="favorite">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_favorite"/>
            </column>
            <column name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="object_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="object_type" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="object_id, object_type, owner_id" constraintName="uk_favorite" tableName="favorite"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-5">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ingredient"/>
            </not>
        </preConditions>
        <createTable tableName="ingredient">
            <column name="dtype" type="VARCHAR(31)">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ingredient_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="aisle" type="VARCHAR(255)"/>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="directions" type="TEXT"/>
            <column name="external_url" type="VARCHAR(255)"/>
            <column name="display_title" type="VARCHAR(255)"/>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT"/>
            <column name="yield" type="INTEGER"/>
            <column name="calories" type="INTEGER"/>
            <column name="total_time" type="INTEGER"/>
            <column name="store_order" type="INTEGER"/>
            <column name="photo" type="VARCHAR"/>
            <column name="photo_type" type="VARCHAR"/>
            <column name="photo_size" type="BIGINT"/>
            <column defaultValueComputed="date_part('epoch'::text, clock_timestamp())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="photo_focus_top" type="FLOAT4"/>
            <column name="photo_focus_left" type="FLOAT4"/>
        </createTable>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_ingredient__eqkey" tableName="ingredient"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-6">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="inventory_item"/>
            </not>
        </preConditions>
        <createTable tableName="inventory_item">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_inventory_item"/>
            </column>
            <column name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="tx_count" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="ingredient_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_inventory_item_user_ingredient" tableName="inventory_item">
            <column name="user_id"/>
            <column name="ingredient_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-7">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="inventory_tx"/>
            </not>
        </preConditions>
        <createTable tableName="inventory_tx">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_inventory_tx"/>
            </column>
            <column name="dtype" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="item_id" type="BIGINT"/>
            <column name="quantity_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="new_quantity_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_inventory_tx_item" tableName="inventory_tx">
            <column name="item_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-8">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="label"/>
            </not>
        </preConditions>
        <createTable tableName="label">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_label"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="name" constraintName="uk_label_name" tableName="label"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-9">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="plan_bucket"/>
            </not>
        </preConditions>
        <createTable tableName="plan_bucket">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_plan_bucket"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="date_part('epoch'::text, clock_timestamp())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="plan_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR"/>
            <column name="date" type="date"/>
            <column defaultValueNumeric="1" name="mod_count" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_plan_bucket__eqkey" tableName="plan_bucket"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-10">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="plan_item"/>
            </not>
        </preConditions>
        <createTable tableName="plan_item">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="task_pkey"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="position" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="parent_id" type="BIGINT"/>
            <column name="owner_id" type="BIGINT"/>
            <column name="_type" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="date_part('epoch'::text, now())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="FLOAT8"/>
            <column name="units_id" type="BIGINT"/>
            <column name="ingredient_id" type="BIGINT"/>
            <column name="preparation" type="VARCHAR"/>
            <column defaultValueNumeric="0" name="status_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="bucket_id" type="BIGINT"/>
            <column name="aggregate_id" type="BIGINT"/>
            <column name="notes" type="VARCHAR"/>
            <column name="trash_bin_id" type="BIGINT"/>
            <column defaultValueNumeric="1" name="mod_count" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_task__eqkey" tableName="plan_item"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-11">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="recipe_fulltext_reindex_queue"/>
            </not>
        </preConditions>
        <createTable tableName="recipe_fulltext_reindex_queue">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_recipe_reindex_queue"/>
            </column>
            <column defaultValueComputed="clock_timestamp()" name="ts" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="idx_recipe_fulltext_reindex_queue_ts" tableName="recipe_fulltext_reindex_queue">
            <column defaultValueComputed="clock_timestamp()" name="ts"/>
        </createIndex>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-12">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="recipe_ingredients"/>
            </not>
        </preConditions>
        <createTable tableName="recipe_ingredients">
            <column name="recipe_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="ingredient_id" type="BIGINT"/>
            <column name="preparation" type="VARCHAR"/>
            <column name="raw" type="VARCHAR"/>
            <column defaultValueComputed="power((2)::double precision, (30)::double precision)" name="_order" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="FLOAT8"/>
            <column name="units_id" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-13">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="textract_job"/>
            </not>
        </preConditions>
        <createTable tableName="textract_job">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_textract_job"/>
            </column>
            <column defaultValueComputed="date_part('epoch'::text, clock_timestamp())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="object_key" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="content_type" type="VARCHAR"/>
            <column name="size" type="BIGINT"/>
            <column defaultValueBoolean="false" name="ready" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="textract_job_owner" tableName="textract_job">
            <column name="owner_id"/>
        </createIndex>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_textract_job__eqkey" tableName="textract_job"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-14">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="timer"/>
            </not>
        </preConditions>
        <createTable tableName="timer">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="timer_pkey"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="date_part('epoch'::text, clock_timestamp())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="duration" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="paused_at" type="TIMESTAMP WITH TIME ZONE"/>
            <column defaultValueNumeric="0" name="extra_time" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-15">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="unit_of_measure"/>
            </not>
        </preConditions>
        <createTable tableName="unit_of_measure">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_uom"/>
            </column>
            <column name="name" type="VARCHAR"/>
            <column name="plural_name" type="VARCHAR"/>
            <column defaultValueComputed="date_part('epoch'::text, now())" name="_eqkey" type="BIGINT"/>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-16">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <createTable tableName="users">
            <column name="id" type="BIGINT" defaultValue="nextval('public.id_seq'::regclass)">
                <constraints nullable="false" primaryKey="true" primaryKeyName="users_pkey"/>
            </column>
            <column name="email" type="VARCHAR(255)"/>
            <column name="image_url" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="provider" type="VARCHAR(255)"/>
            <column name="provider_id" type="VARCHAR(255)"/>
            <column defaultValueComputed="date_part('epoch'::text, now())" name="_eqkey" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="created_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="updated_at" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint columnNames="email" constraintName="uk6dotkott2kjsp8vw4d0m25fb7" tableName="users"/>
        <addUniqueConstraint columnNames="_eqkey" constraintName="uk_users__eqkey" tableName="users"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-17">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="compound_quantity_components"/>
            </not>
        </preConditions>
        <createTable tableName="compound_quantity_components">
            <column name="compound_quantity_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="FLOAT8"/>
            <column name="units_id" type="BIGINT"/>
        </createTable>
        <createIndex indexName="idx_compound_quantity_components_compound_quantity" tableName="compound_quantity_components">
            <column name="compound_quantity_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-18">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="unit_of_measure_aliases"/>
            </not>
        </preConditions>
        <createTable tableName="unit_of_measure_aliases">
            <column name="unit_of_measure_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_uom_aliases"/>
            </column>
            <column name="alias" type="VARCHAR">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_uom_aliases"/>
            </column>
        </createTable>
        <createIndex indexName="idx_uom_alias" tableName="unit_of_measure_aliases">
            <column name="alias"/>
        </createIndex>
        <addUniqueConstraint columnNames="name" constraintName="uk_uom_name" tableName="unit_of_measure"/>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-19">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="textract_job_lines"/>
            </not>
        </preConditions>
        <createTable tableName="textract_job_lines">
            <column name="textract_job_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="x" type="FLOAT8">
                <constraints nullable="false"/>
            </column>
            <column name="y" type="FLOAT8">
                <constraints nullable="false"/>
            </column>
            <column name="width" type="FLOAT8">
                <constraints nullable="false"/>
            </column>
            <column name="height" type="FLOAT8">
                <constraints nullable="false"/>
            </column>
            <column name="text" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex indexName="textract_job_lines_job" tableName="textract_job_lines">
            <column name="textract_job_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-39">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="ingredient_labels"/>
            </not>
        </preConditions>
        <createTable tableName="ingredient_labels">
            <column name="ingredient_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="label_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-40">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="plan_grants"/>
            </not>
        </preConditions>
        <createTable tableName="plan_grants">
            <column name="plan_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_task_list_grants"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_task_list_grants"/>
            </column>
            <column name="level_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-41">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="timer_grants"/>
            </not>
        </preConditions>
        <createTable tableName="timer_grants">
            <column name="timer_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_timer_grants"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_timer_grants"/>
            </column>
            <column name="level_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="liquibase (barneyb)" id="1709518116553-42">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="unit_of_measure_conversions"/>
            </not>
        </preConditions>
        <createTable tableName="unit_of_measure_conversions">
            <column name="unit_of_measure_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_uom_conversions"/>
            </column>
            <column name="target_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_uom_conversions"/>
            </column>
            <column name="factor" type="FLOAT8"/>
        </createTable>
    </changeSet>

    <changeSet author="liquibase (barneyb)" id="1709518116553-foreign-keys">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_favorite_user"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="favorite" constraintName="fk_favorite_user" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="ingredient" constraintName="fk_ingredient_owner" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="inventory_item" constraintName="fk_inventory_item_pantry_item_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="quantity_id" baseTableName="inventory_item" constraintName="fk_inventory_item_quantity_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="compound_quantity" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="inventory_item" constraintName="fk_inventory_item_user_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="item_id" baseTableName="inventory_tx" constraintName="fk_inventory_tx_item_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="inventory_item" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="new_quantity_id" baseTableName="inventory_tx" constraintName="fk_inventory_tx_new_quantity_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="compound_quantity" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="quantity_id" baseTableName="inventory_tx" constraintName="fk_inventory_tx_quantity_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="compound_quantity" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="plan_id" baseTableName="plan_bucket" constraintName="fk_plan_bucket_plan_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="plan_item" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="aggregate_id" baseTableName="plan_item" constraintName="fk_task_aggregate_id" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="plan_item" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="bucket_id" baseTableName="plan_item" constraintName="fk_task_bucket_id" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="plan_bucket" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="plan_item" constraintName="fk_task_ingredients_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="units_id" baseTableName="plan_item" constraintName="fk_task_ingredients_units_id" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="plan_item" constraintName="fk_task_owner" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="plan_item" constraintName="fk_task_parent" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="plan_item" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="trash_bin_id" baseTableName="plan_item" constraintName="fk_task_trash_bin" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="plan_item" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="id" baseTableName="recipe_fulltext_reindex_queue" constraintName="fk_recipe_reindex_queue" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="recipe_ingredients" constraintName="fk115hxprua4ai0chlhicwmuhna" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="recipe_id" baseTableName="recipe_ingredients" constraintName="fk8kr5xdvi2l7pswlri2i70g8av" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="units_id" baseTableName="recipe_ingredients" constraintName="fk_recipe_ingredients_units_id" deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="textract_job" constraintName="fk_textract_job_owner_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="owner_id" baseTableName="timer" constraintName="fk_timer_owner" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="compound_quantity_id" baseTableName="compound_quantity_components" constraintName="fk_compound_quantity_components_compound_quantity_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="compound_quantity" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="units_id" baseTableName="compound_quantity_components" constraintName="fk_compound_quantity_components_units_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="unit_of_measure_id" baseTableName="unit_of_measure_aliases" constraintName="fk_uom_aliases_oum_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="textract_job_id" baseTableName="textract_job_lines" constraintName="fk_textract_job_lines_job_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="textract_job" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="ingredient_id" baseTableName="ingredient_labels" constraintName="fk_ingredient_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ingredient" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="label_id" baseTableName="ingredient_labels" constraintName="fk_label_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="label" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="plan_id" baseTableName="plan_grants" constraintName="fk_task_list_grants_task" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="plan_item" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="plan_grants" constraintName="fk_task_list_grants_user" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="timer_id" baseTableName="timer_grants" constraintName="fk_timer_grants_timer" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="timer" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="timer_grants" constraintName="fk_timer_grants_user" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="target_id" baseTableName="unit_of_measure_conversions" constraintName="fk_oum_conversions_oum_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
        <addForeignKeyConstraint baseColumnNames="unit_of_measure_id" baseTableName="unit_of_measure_conversions" constraintName="fk_oum_conversions_target_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="unit_of_measure" validate="true"/>
    </changeSet>

    <changeSet author="barneyb" id="1709518116553-check-constraints">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from pg_constraint
                where conname = 'chk_ingredient_owner_id'
            </sqlCheck>
        </preConditions>
        <sql>
            alter table ingredient
                add constraint chk_ingredient_owner_id CHECK (
                    CASE dtype
                        WHEN 'Recipe'::text THEN owner_id IS NOT NULL
                        ELSE owner_id IS NULL
                    END);
        </sql>
        <sql>
            alter table plan_item
                add constraint "chk_task_owner_id" CHECK (
                    CASE _type
                        WHEN 'plan'::text THEN owner_id IS NOT NULL
                        ELSE owner_id IS NULL
                    END),
                add constraint "chk_task_parent_id" CHECK (
                    CASE _type
                        WHEN 'plan'::text THEN parent_id IS NULL
                        ELSE parent_id IS NOT NULL
                    END);
        </sql>
        <sql>
            alter table timer
                add constraint chk_timer_duration check ( duration > 0 ),
                add constraint chk_timer_pause_duration check ( extra_time >= 0 );
        </sql>
    </changeSet>

    <changeSet author="barneyb" id="1709518116553-fulltext-search">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from pg_proc
                where proname = 'recipe_fulltext_update'
            </sqlCheck>
        </preConditions>
        <sql>
            CREATE EXTENSION unaccent;
            CREATE EXTENSION btree_gin;

            CREATE TEXT SEARCH CONFIGURATION en (COPY = english);
            ALTER TEXT SEARCH CONFIGURATION en
                ALTER MAPPING FOR hword, hword_part, word
                    WITH unaccent, english_stem;
        </sql>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION recipe_fulltext_update(id BIGINT) RETURNS VOID AS
            $$
BEGIN
    UPDATE ingredient
    SET recipe_fulltext = SETWEIGHT(TO_TSVECTOR('en', COALESCE(ingredient.name, '')), 'A') ||
                          SETWEIGHT(TO_TSVECTOR('en', COALESCE(
                                  (SELECT STRING_AGG(l.name, ' ' ORDER BY l.name)
                                   FROM ingredient_labels il
                                        JOIN label l ON l.id = il.label_id
                                   WHERE il.ingredient_id = ingredient.id), '')), 'B') ||
                          SETWEIGHT(TO_TSVECTOR('en', COALESCE(
                                  (SELECT STRING_AGG(
                                                  CASE
                                                      WHEN i.id IS NULL THEN raw
                                                      ELSE COALESCE(i.name, '') || ' ' || COALESCE(preparation, '')
                                                      END,
                                                  CHR(10) ORDER BY _order)
                                   FROM recipe_ingredients link
                                        LEFT JOIN ingredient i ON link.ingredient_id = i.id
                                   WHERE recipe_id = ingredient.id), '')), 'C') ||
                          SETWEIGHT(TO_TSVECTOR('en', COALESCE(ingredient.directions, '')), 'D')
    WHERE ingredient.id = recipe_fulltext_update.id
      AND ingredient.dtype = 'Recipe';
END
$$ LANGUAGE plpgsql;
        </sql>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION recipe_fulltext_update_handler() RETURNS TRIGGER AS
            $$
BEGIN
    PERFORM recipe_fulltext_update(old_table.id)
    FROM old_table;
    RETURN NULL;
END
$$ LANGUAGE plpgsql;
        </sql>
        <sql>
            ALTER TABLE ingredient
                ADD recipe_fulltext tsvector NULL;

            CREATE INDEX idx_recipe_fulltext ON ingredient
                USING GIN (recipe_fulltext, owner_id)
                WHERE dtype = 'Recipe';

            CREATE TRIGGER recipe_fulltext_update_trigger
                AFTER DELETE
                ON recipe_fulltext_reindex_queue
                REFERENCING OLD TABLE AS old_table
                FOR EACH ROW
            EXECUTE PROCEDURE recipe_fulltext_update_handler();
        </sql>
    </changeSet>
</databaseChangeLog>
